name: Build and Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # OPTIONAL: Deploy to WP Engine (Requires Secrets)
      # Uncomment and configure if using GitHub Actions to deploy
      # Git Deployment Method (Consistent with WP Engine documentation)
      - name: Deploy to WP Engine (Git Push)
        env:
          WPE_SSH_KEY: ${{ secrets.WPE_SSH_KEY_PRIVATE }}
          WPE_GIT_REMOTE: "git@git.wpengine.com:production/chrisslaterai.git"
        run: |
          if [ -z "$WPE_SSH_KEY" ]; then
            echo "::error::WPE_SSH_KEY_PRIVATE secret is not set!"
            exit 1
          fi

          # 1. Setup SSH Key
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$WPE_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Use GIT_SSH_COMMAND to ignore host checking
          export GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o IdentitiesOnly=yes"

          # 2. Configure Git
          git config --global user.email "deploy@github.actions"
          git config --global user.name "GitHub Actions Helper"

          # 3. Add WPE Remote
          git remote add wpe "$WPE_GIT_REMOTE"

          # 4. Push to WP Engine
          # Since the artifacts are now in the repo, we can just push the current branch (main)
          echo "ðŸš€ Syncing with WP Engine..."
          git push -v -f wpe main:main

          echo "âœ… Git Deployment Complete"
